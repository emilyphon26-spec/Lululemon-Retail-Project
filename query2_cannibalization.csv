-- SIMPLER VERSION: Compare category sales during ANY promo vs no promos

WITH category_with_promo AS (
    -- Sales for entire category when ANY product in it is promoted
    SELECT 
        p.category,
        AVG(t.quantity) as avg_qty
    FROM transactions t
    JOIN products p ON t.product_id = p.product_id
    WHERE EXISTS (
        SELECT 1 FROM promotions pr
        JOIN products p2 ON pr.product_id = p2.product_id
        WHERE p2.category = p.category
        AND t.date BETWEEN pr.start_date AND pr.end_date
    )
    GROUP BY p.category
),
category_no_promo AS (
    -- Sales for entire category when NO products in it are promoted
    SELECT 
        p.category,
        AVG(t.quantity) as avg_qty
    FROM transactions t
    JOIN products p ON t.product_id = p.product_id
    WHERE NOT EXISTS (
        SELECT 1 FROM promotions pr
        JOIN products p2 ON pr.product_id = p2.product_id
        WHERE p2.category = p.category
        AND t.date BETWEEN pr.start_date AND pr.end_date
    )
    GROUP BY p.category
)

SELECT 
    wp.category,
    ROUND(wp.avg_qty, 2) as avg_qty_category_with_promo,
    ROUND(np.avg_qty, 2) as avg_qty_category_no_promo,
    ROUND(wp.avg_qty - np.avg_qty, 2) as difference
FROM category_with_promo wp
JOIN category_no_promo np ON wp.category = np.category
ORDER BY difference;